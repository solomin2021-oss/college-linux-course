name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è Project Board

on:
  pull_request:
    types: [opened, reopened, ready_for_review, closed]
  pull_request_review:
    types: [submitted]

env:
  PROJECT_NUMBER: 4
  OWNER: virusneo1997-del
  IS_ORGANIZATION: false

jobs:
  automate-project:
    runs-on: ubuntu-latest
    steps:
      - name: üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
        uses: actions/github-script@v6
        with:
          script: |
            console.log('=== üöÄ –ó–ê–ü–£–°–ö –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò ===');
            
            const { pull_request } = context.payload;
            if (!pull_request) {
              console.log('‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ PR');
              return;
            }
            
            const author = pull_request.user.login;
            const prAction = context.payload.action;
            const prMerged = pull_request.merged;
            const reviewState = context.payload.review?.state;
            
            console.log(`üë§ –ê–≤—Ç–æ—Ä PR: ${author}`);
            console.log(`üîß –î–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
            console.log(`üîÑ –ú–µ—Ä–∂: ${prMerged}`);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏—è
            let newStatus = null;
            
            if (context.eventName === 'pull_request') {
              switch (prAction) {
                case 'opened':
                case 'reopened':
                  newStatus = 'In Progress';
                  break;
                case 'ready_for_review':
                  newStatus = 'In Review';
                  break;
                case 'closed':
                  newStatus = prMerged ? 'Done' : 'To do';
                  break;
              }
            } else if (context.eventName === 'pull_request_review') {
              if (reviewState === 'approved') {
                newStatus = 'Done';
              }
            }
            
            if (!newStatus) {
              console.log('‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è');
              return;
            }
            
            console.log(`üéØ –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${newStatus}`);
            
            try {
              // 1. –ü–æ–ª—É—á–∞–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ user)
              const entityType = '${{ env.IS_ORGANIZATION }}' === 'true' ? 'organization' : 'user';
              
              const projectQuery = `
                query getProject($owner: String!, $number: Int!) {
                  ${entityType}(login: $owner) {
                    projectV2(number: $number) {
                      id
                      fields(first: 20) {
                        nodes {
                          ... on ProjectV2Field {
                            id
                            name
                          }
                          ... on ProjectV2SingleSelectField {
                            id
                            name
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const projectResult = await github.graphql(projectQuery, {
                owner: '${{ env.OWNER }}',
                number: ${{ env.PROJECT_NUMBER }}
              });
              
              const project = projectResult[entityType]?.projectV2;
              if (!project) {
                console.log('‚ùå –ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
              }
              
              const projectId = project.id;
              console.log(`üìä –ù–∞–π–¥–µ–Ω –ø—Ä–æ–µ–∫—Ç: ${projectId}`);
              
              // 2. –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–µ Status
              const statusField = project.fields.nodes.find(field => field.name === 'Status');
              if (!statusField) {
                console.log('‚ùå –ü–æ–ª–µ Status –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ');
                return;
              }
              
              // 3. –ù–∞—Ö–æ–¥–∏–º –æ–ø—Ü–∏—é —Å—Ç–∞—Ç—É—Å–∞
              const statusOption = statusField.options.find(option => option.name === newStatus);
              if (!statusOption) {
                console.log(`‚ùå –û–ø—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞ '${newStatus}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                console.log(`üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏:`, statusField.options.map(opt => opt.name));
                return;
              }
              
              // 4. –ù–∞—Ö–æ–¥–∏–º –∫–∞—Ä—Ç–æ—á–∫—É —Å—Ç—É–¥–µ–Ω—Ç–∞ –ø–æ –ø–æ–ª—é Student GitHub
              const itemsQuery = `
                query getProjectItems($projectId: ID!) {
                  node(id: $projectId) {
                    ... on ProjectV2 {
                      items(first: 50) {
                        nodes {
                          id
                          fieldValues(first: 10) {
                            nodes {
                              ... on ProjectV2ItemFieldTextValue {
                                field {
                                  ... on ProjectV2FieldCommon {
                                    name
                                  }
                                }
                                text
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const itemsResult = await github.graphql(itemsQuery, { projectId });
              const items = itemsResult.node.items.nodes;
              
              // –ò—â–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ Student GitHub
              const studentItem = items.find(item => {
                const githubField = item.fieldValues.nodes.find(f => 
                  f.field && f.field.name === 'Student GitHub'
                );
                return githubField && githubField.text === author;
              });
              
              if (!studentItem) {
                console.log(`‚ùå –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`);
                console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏:');
                items.forEach(item => {
                  const githubField = item.fieldValues.nodes.find(f => 
                    f.field && f.field.name === 'Student GitHub'
                  );
                  if (githubField) {
                    console.log(`- ${githubField.text}`);
                  }
                });
                return;
              }
              
              console.log(`üìé –ù–∞–π–¥–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞: ${studentItem.id}`);
              
              // 5. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏
              const updateMutation = `
                mutation updateProjectItem($input: UpdateProjectV2ItemFieldValueInput!) {
                  updateProjectV2ItemFieldValue(input: $input) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;
              
              const updateInput = {
                projectId,
                itemId: studentItem.id,
                fieldId: statusField.id,
                value: {
                  singleSelectOptionId: statusOption.id
                }
              };
              
              await github.graphql(updateMutation, { input: updateInput });
              console.log(`‚úÖ –ö–∞—Ä—Ç–æ—á–∫–∞ —Å—Ç—É–¥–µ–Ω—Ç–∞ ${author} –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ —Å—Ç–∞—Ç—É—Å: ${newStatus}`);
              
            } catch (error) {
              console.error('üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç–æ—á–∫–∏:', error);
              console.log('üîß –°–æ–≤–µ—Ç: –ü—Ä–æ–≤–µ—Ä—å PROJECT_NUMBER –∏ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞');
            }
