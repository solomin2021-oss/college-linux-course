name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è Project Board

on:
  pull_request:
    types: [opened, reopened, ready_for_review, closed, converted_to_draft]

env:
  USER_LOGIN: "virusneo1997-del"

jobs:
  automate-project:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
      repository-projects: write
    steps:
      - name: üéØ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('=== üöÄ –ó–ê–ü–£–°–ö –ê–í–¢–û–ú–ê–¢–ò–ó–ê–¶–ò–ò ===');
            
            // 1. –û–¢–õ–ê–î–ö–ê - –ü–û–ö–ê–ñ–ï–ú –í–°–ï –ü–†–û–ï–ö–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
            try {
              console.log('üîç –ò—â–µ–º –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
              const projectsQuery = `query {
                user(login: "${process.env.USER_LOGIN}") {
                  projectsV2(first: 10) {
                    nodes {
                      number
                      title
                      id
                      url
                    }
                  }
                }
              }`;
              
              const projectsResult = await github.graphql(projectsQuery);
              const projects = projectsResult.user.projectsV2.nodes;
              
              console.log('üìã –í–°–ï –ü–†–û–ï–ö–¢–´ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:');
              projects.forEach((project, index) => {
                console.log(`${index + 1}. "${project.title}"`);
                console.log(`   –ù–æ–º–µ—Ä: ${project.number}`);
                console.log(`   ID: ${project.id}`);
                console.log(`   URL: ${project.url}`);
                console.log(`   ---`);
              });
              
              if (projects.length === 0) {
                console.log('‚ùå –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤!');
                return;
              }
              
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç
              const targetProject = projects[0];
              console.log(`üéØ –ò–°–ü–û–õ–¨–ó–£–ï–ú –ü–†–û–ï–ö–¢: "${targetProject.title}" (–Ω–æ–º–µ—Ä: ${targetProject.number})`);
              
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
              const projectId = targetProject.id;
              
              // 2. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò PR
              const { pull_request } = context.payload;
              if (!pull_request) {
                console.log('‚ùå –ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ PR');
                return;
              }
              
              const author = pull_request.user.login;
              const prAction = context.payload.action;
              const prState = pull_request.state;
              const prMerged = pull_request.merged;
              const prTitle = pull_request.title;
              const prDraft = pull_request.draft;
              
              console.log(`üë§ –ê–≤—Ç–æ—Ä PR: ${author}`);
              console.log(`üîß –î–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
              console.log(`üìù –ó–∞–≥–æ–ª–æ–≤–æ–∫: ${prTitle}`);
              console.log(`üîÑ –°—Ç–∞—Ç—É—Å PR: ${prState}`);
              console.log(`‚úÖ –ú–µ—Ä–∂: ${prMerged}`);
              console.log(`üìù –ß–µ—Ä–Ω–æ–≤–∏–∫: ${prDraft}`);
              
              // –û–ü–†–ï–î–ï–õ–Ø–ï–ú –ù–û–í–´–ô –°–¢–ê–¢–£–°
              let newStatus = null;
              
              switch (prAction) {
                case 'opened':
                  if (prDraft) {
                    newStatus = 'To do';
                    console.log('üéØ PR –æ—Ç–∫—Ä—ã—Ç –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: To do');
                  } else {
                    newStatus = 'In Progress';
                    console.log('üéØ PR –æ—Ç–∫—Ä—ã—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: In Progress');
                  }
                  break;
                  
                case 'reopened':
                  newStatus = 'To do';
                  console.log('üéØ PR –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: To do');
                  break;
                  
                case 'ready_for_review':
                  newStatus = 'In Review';
                  console.log('üéØ PR –≥–æ—Ç–æ–≤ –∫ –ø—Ä–æ–≤–µ—Ä–∫–µ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: In Review');
                  break;
                  
                case 'converted_to_draft':
                  newStatus = 'To do';
                  console.log('üéØ PR –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —á–µ—Ä–Ω–æ–≤–∏–∫ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: To do');
                  break;
                  
                case 'closed':
                  if (prMerged) {
                    newStatus = 'Done';
                    console.log('üéØ PR –º–µ—Ä–∂–µ–Ω - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: Done');
                  } else {
                    newStatus = 'To do';
                    console.log('üéØ PR –∑–∞–∫—Ä—ã—Ç –±–µ–∑ –º–µ—Ä–∂–∞ - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º: To do');
                  }
                  break;
                  
                default:
                  console.log(`‚ÑπÔ∏è –ù–µ–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ: ${prAction}`);
                  return;
              }
              
              if (!newStatus) {
                console.log('‚ÑπÔ∏è –°—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è');
                return;
              }
              
              console.log(`üéØ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å: ${newStatus}`);
              
              // 3. –ü–û–õ–£–ß–ê–ï–ú –ò–ù–§–û–†–ú–ê–¶–ò–Æ –û –ü–†–û–ï–ö–¢–ï
              const projectDetailsQuery = `query GetProjectDetails($projectId: ID!) {
                node(id: $projectId) {
                  ... on ProjectV2 {
                    title
                    fields(first: 10) {
                      nodes {
                        ... on ProjectV2Field {
                          id
                          name
                        }
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                    items(first: 50) {
                      nodes {
                        id
                        fieldValues(first: 10) {
                          nodes {
                            ... on ProjectV2ItemFieldTextValue {
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                              text
                            }
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              field {
                                ... on ProjectV2FieldCommon {
                                  name
                                }
                              }
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }`;
              
              const projectDetails = await github.graphql(projectDetailsQuery, { projectId });
              const project = projectDetails.node;
              
              console.log(`üìä –ü—Ä–æ–µ–∫—Ç: ${project.title}`);
              
              // 4. –ù–ê–•–û–î–ò–ú –ü–û–õ–ï STATUS
              const statusField = project.fields.nodes.find(field => 
                field.name === 'Status' && field.options
              );
              
              if (!statusField) {
                console.log('‚ùå –ü–æ–ª–µ Status –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç –æ–ø—Ü–∏–π');
                console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è:', project.fields.nodes.map(f => ({
                  name: f.name,
                  hasOptions: !!f.options
                })));
                return;
              }
              
              console.log(`üìã –ü–æ–ª–µ Status: ${statusField.id}`);
              console.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã:', statusField.options.map(o => o.name));
              
              // 5. –ù–ê–•–û–î–ò–ú –û–ü–¶–ò–Æ –°–¢–ê–¢–£–°–ê
              const statusOption = statusField.options.find(option => option.name === newStatus);
              if (!statusOption) {
                console.log(`‚ùå –û–ø—Ü–∏—è "${newStatus}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ø–æ–ª–µ Status`);
                return;
              }
              
              console.log(`üìã –û–ø—Ü–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${statusOption.name} (ID: ${statusOption.id})`);
              
              // 6. –ò–©–ï–ú –ö–ê–†–¢–û–ß–ö–£ –°–¢–£–î–ï–ù–¢–ê –ò–õ–ò –°–û–ó–î–ê–ï–ú –ù–û–í–£–Æ
              console.log(`üîç –ò—â–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è: ${author}`);
              console.log(`üìä –í—Å–µ–≥–æ –∫–∞—Ä—Ç–æ—á–µ–∫: ${project.items.nodes.length}`);
              
              let studentItem = project.items.nodes.find(item => {
                const githubField = item.fieldValues.nodes.find(f => 
                  f.field && f.field.name === 'Student GitHub' && f.text
                );
                return githubField && githubField.text === author;
              });
              
              // üîÑ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –°–û–ó–î–ê–ù–ò–ï –ö–ê–†–¢–û–ß–ö–ò –ï–°–õ–ò –ù–ï –ù–ê–ô–î–ï–ù–ê
              if (!studentItem) {
                console.log(`üÜï –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è ${author} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ - —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é...`);
                
                // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª–µ Student GitHub
                const studentGitHubField = project.fields.nodes.find(field => 
                  field.name === 'Student GitHub'
                );
                
                if (!studentGitHubField) {
                  console.log('‚ùå –ü–æ–ª–µ Student GitHub –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ø—Ä–æ–µ–∫—Ç–µ');
                  return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                const createItemMutation = `mutation CreateProjectItem($input: AddProjectV2ItemByIdInput!) {
                  addProjectV2ItemById(input: $input) {
                    item {
                      id
                    }
                  }
                }`;
                
                const createResult = await github.graphql(createItemMutation, {
                  input: {
                    projectId: projectId,
                    contentId: pull_request.node_id
                  }
                });
                
                const newItemId = createResult.addProjectV2ItemById.item.id;
                console.log(`‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: ${newItemId}`);
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–µ Student GitHub
                const updateGitHubMutation = `mutation UpdateStudentGitHub($input: UpdateProjectV2ItemFieldValueInput!) {
                  updateProjectV2ItemFieldValue(input: $input) {
                    projectV2Item {
                      id
                    }
                  }
                }`;
                
                await github.graphql(updateGitHubMutation, {
                  input: {
                    projectId: projectId,
                    itemId: newItemId,
                    fieldId: studentGitHubField.id,
                    value: { text: author }
                  }
                });
                
                console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω Student GitHub: ${author}`);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                studentItem = { id: newItemId };
                
              } else {
                console.log(`üìé –ù–∞–π–¥–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: ${studentItem.id}`);
              }
              
              // 7. –û–ë–ù–û–í–õ–Ø–ï–ú –°–¢–ê–¢–£–°
              const updateMutation = `mutation UpdateStatus($input: UpdateProjectV2ItemFieldValueInput!) {
                updateProjectV2ItemFieldValue(input: $input) {
                  projectV2Item {
                    id
                  }
                }
              }`;
              
              await github.graphql(updateMutation, {
                input: {
                  projectId: projectId,
                  itemId: studentItem.id,
                  fieldId: statusField.id,
                  value: { singleSelectOptionId: statusOption.id }
                }
              });
              
              console.log(`‚úÖ –£–°–ü–ï–•: ${author} –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ "${newStatus}"`);
              
            } catch (error) {
              console.error('üí• –û–®–ò–ë–ö–ê:', error.message);
              if (error.errors) {
                console.log('üìã GraphQL –æ—à–∏–±–∫–∏:', JSON.stringify(error.errors, null, 2));
              }
            }
            
            console.log('=== üèÅ –ó–ê–í–ï–†–®–ï–ù–ò–ï ===');