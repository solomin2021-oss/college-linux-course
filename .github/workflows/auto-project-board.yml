name: Auto Project Board Sync

on:
  pull_request_target:
    types: [opened, reopened, synchronize, closed]

permissions:
  contents: read
  pull-requests: write
  issues: write
  repository-projects: write

jobs:
  sync-project:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.base.repo.full_name }}
          ref: ${{ github.event.pull_request.base.ref }}
          token: ${{ secrets.PROJECT_ACCESS_TOKEN }}

      - name: Add or move PR to project
        if: github.event.action != 'closed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          script: |
            const projectName = "Автоматизация курсов";
            const columnName = "In review";

            const { data: projects } = await github.rest.projects.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const project = projects.find(p => p.name === projectName);
            if (!project) {
              core.setFailed(`❌ Проект "${projectName}" не найден`);
              return;
            }

            const { data: columns } = await github.rest.projects.listColumns({
              project_id: project.id,
            });

            const column = columns.find(c => c.name === columnName);
            if (!column) {
              core.setFailed(`❌ Колонка "${columnName}" не найдена`);
              return;
            }

            // Проверяем, есть ли карточка для этого PR
            const { data: cards } = await github.rest.projects.listCards({
              column_id: column.id,
            });

            const existingCard = cards.find(card =>
              card.content_url &&
              card.content_url.endsWith(`/pulls/${context.issue.number}`)
            );

            if (!existingCard) {
              await github.rest.projects.createCard({
                column_id: column.id,
                content_id: context.payload.pull_request.id,
                content_type: "PullRequest",
              });
              core.info(`✅ Карточка добавлена в "${columnName}"`);
            } else {
              core.info(`ℹ️ Карточка уже есть в "${columnName}"`);
            }

      - name: Move PR card back to To do when closed
        if: github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          script: |
            const projectName = "Автоматизация курсов";
            const columnName = "To do";

            const { data: projects } = await github.rest.projects.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const project = projects.find(p => p.name === projectName);
            if (!project) {
              core.setFailed(`❌ Проект "${projectName}" не найден`);
              return;
            }

            const { data: columns } = await github.rest.projects.listColumns({
              project_id: project.id,
            });

            const column = columns.find(c => c.name === columnName);
            if (!column) {
              core.setFailed(`❌ Колонка "${columnName}" не найдена`);
              return;
            }

            // Ищем карточку PR
            for (const c of columns) {
              const { data: cards } = await github.rest.projects.listCards({
                column_id: c.id,
              });

              for (const card of cards) {
                if (card.content_url && card.content_url.endsWith(`/pulls/${context.issue.number}`)) {
                  await github.rest.projects.moveCard({
                    card_id: card.id,
                    position: "top",
                    column_id: column.id,
                  });
                  core.info(`♻️ Карточка перемещена в "${columnName}"`);
                  return;
                }
              }
            }

            core.warning("⚠️ Карточка для этого PR не найдена");
