name: ü§ñ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞–Ω–∏—è —Å—Ç—É–¥–µ–Ω—Ç–∞

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write
  projects: write

jobs:
  check-student:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ PR
      - name: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Pull Request
        run: |
          echo "PR –æ—Ç —Å—Ç—É–¥–µ–Ω—Ç–∞: ${{ github.event.pull_request.user.login }}"
          echo "–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç–∞: ${{ github.event.pull_request.head.repo.full_name }}"
          echo "–í–µ—Ç–∫–∞: ${{ github.event.pull_request.head.ref }}"

      # 2Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º –∫–æ–¥ —Å—Ç—É–¥–µ–Ω—Ç–∞
      - name: Checkout student's repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      # 3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–¥–∞–Ω–∏—è
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–¥–∞–Ω–∏—è
        id: check
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞..."
          if [ ! -d "lessons" ] && [ ! -d "solutions" ]; then
            echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–∞–ø–∫–∞ lessons –∏–ª–∏ solutions"
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          fi

          folder=""
          if [ -d "lessons" ]; then
            folder="lessons"
          else
            folder="solutions"
          fi

          if [ "$(ls -A $folder)" ]; then
            echo "‚úÖ –ù–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ $folder"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå –ü–∞–ø–∫–∞ $folder –ø—É—Å—Ç–∞"
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          fi

      # 4Ô∏è‚É£ –ö–æ–º–º–µ–Ω—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç—É–¥–µ–Ω—Ç—É
      - name: –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å—Ç—É–¥–µ–Ω—Ç—É
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          script: |
            const result = "${{ steps.check.outputs.result }}";
            let message = "";

            if (result === "success") {
              message = `‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!\n\n–§–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã, –∑–∞–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–¥–∞–Ω–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—é –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É.`;
            } else {
              message = `‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞.\n\n–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –≤–µ—Ä–Ω–∞—è (–µ—Å—Ç—å –ø–∞–ø–∫–∞ *lessons* –∏–ª–∏ *solutions*) –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

      # 5Ô∏è‚É£ –î–æ–±–∞–≤–ª—è–µ–º PR –≤ Project Board ‚Äú–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫—É—Ä—Å–æ–≤‚Äù ‚Üí –∫–æ–ª–æ–Ω–∫—É ‚ÄúIn review‚Äù
      - name: –î–æ–±–∞–≤–∏—Ç—å PR –≤ Project Board
        if: steps.check.outputs.result == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_ACCESS_TOKEN }}
          script: |
            const projectName = "–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –∫—É—Ä—Å–æ–≤";
            const columnName = "In review";

            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–µ–∫—Ç–æ–≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
            const { data: projects } = await github.rest.projects.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const project = projects.find(p => p.name === projectName);
            if (!project) {
              core.setFailed(`‚ùå –ü—Ä–æ–µ–∫—Ç "${projectName}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
              return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞
            const { data: columns } = await github.rest.projects.listColumns({
              project_id: project.id,
            });

            const column = columns.find(c => c.name === columnName);
            if (!column) {
              core.setFailed(`‚ùå –ö–æ–ª–æ–Ω–∫–∞ "${columnName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ "${projectName}".`);
              return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É PR –≤ –ø—Ä–æ–µ–∫—Ç
            await github.rest.projects.createCard({
              column_id: column.id,
              content_id: context.payload.pull_request.id,
              content_type: "PullRequest"
            });

            console.log(`‚úÖ PR –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø—Ä–æ–µ–∫—Ç "${projectName}" ‚Üí –∫–æ–ª–æ–Ω–∫—É "${columnName}".`);
